<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Solar ATAP Feasibility Simulator — PowerRoof.my</title>
<style>
*{margin:0;padding:0;box-sizing:border-box}
:root{
  --amber:#F59E0B;--amber-dim:#92400E;--green:#22C55E;--red:#EF4444;--blue:#3B82F6;
  --g900:#0a0a0a;--g800:#171717;--g700:#262626;--g600:#404040;--g500:#6b7280;
  --g400:#9ca3af;--g300:#d1d5db;--border:#333;
}
body{background:var(--g900);color:#fff;font-family:'Inter',-apple-system,BlinkMacSystemFont,sans-serif;min-height:100vh}
.container{max-width:720px;margin:0 auto;padding:0 24px}
.card{background:var(--g800);border:1px solid var(--border);border-radius:12px;padding:32px}
h2{font-size:26px;font-weight:700;margin-bottom:8px}
.subtitle{color:var(--g400);font-size:15px;margin-bottom:32px}
.btn{background:var(--amber);color:var(--g900);border:none;border-radius:8px;padding:14px 32px;font-size:16px;font-weight:700;cursor:pointer;display:inline-flex;align-items:center;gap:8px;transition:transform .15s,box-shadow .15s}
.btn:hover{transform:translateY(-2px);box-shadow:0 8px 24px rgba(245,158,11,.27)}
label{font-size:13px;color:var(--g400);margin-bottom:6px;display:block;font-weight:500}
select{width:100%;padding:10px 12px;background:var(--g700);color:#fff;border:1px solid var(--border);border-radius:8px;font-size:14px;appearance:none;outline:none}
input[type=range]{width:100%;accent-color:var(--amber);height:6px}
.metric-grid{display:grid;grid-template-columns:1fr 1fr;gap:16px;margin-bottom:24px}
.metric{background:var(--g700);border-radius:10px;padding:16px 18px}
.metric-label{font-size:11px;color:var(--g400);margin-bottom:4px;text-transform:uppercase;letter-spacing:1px}
.metric-value{font-size:22px;font-weight:800;font-family:monospace}
.hours-btn{flex:1;padding:10px 16px;border-radius:8px;font-size:14px;font-weight:600;cursor:pointer;transition:all .2s;border:1px solid var(--border);background:var(--g700);color:#fff}
.hours-btn.active{background:var(--amber);color:var(--g900);border-color:var(--amber)}
.score-bar-track{height:8px;background:var(--g700);border-radius:4px;overflow:hidden}
.score-bar-fill{height:100%;border-radius:4px;transition:width .8s cubic-bezier(.4,0,.2,1)}
.insight{background:rgba(245,158,11,.1);border:1px solid rgba(245,158,11,.2);border-radius:8px;padding:10px 14px;font-size:13px;color:var(--amber);display:flex;gap:8px;align-items:center;transition:all .4s;margin-top:12px}
.tier-card{background:var(--g800);border:1px solid var(--border);border-radius:12px;padding:28px 20px;text-align:center}
/* Progress bar */
.progress-bar{position:fixed;top:0;left:0;right:0;z-index:50;background:var(--g800);border-bottom:1px solid var(--border)}
.progress-inner{max-width:720px;margin:0 auto;padding:12px 24px}
.progress-track{height:4px;background:var(--g700);border-radius:2px;overflow:hidden}
.progress-fill{height:100%;background:var(--amber);border-radius:2px;transition:width .5s}
/* Hide all steps by default */
.step{display:none}
.step.active{display:block}
</style>
</head>
<body>

<!-- Progress bar -->
<div class="progress-bar" id="progressBar" style="display:none">
  <div class="progress-inner">
    <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:6px">
      <span style="font-size:12px;color:var(--g400);font-weight:500">SOLAR ATAP FEASIBILITY SIMULATOR</span>
      <span style="font-size:12px;color:var(--amber);font-weight:600" id="stepLabel">Step 1 of 6</span>
    </div>
    <div class="progress-track"><div class="progress-fill" id="progressFill" style="width:0%"></div></div>
  </div>
</div>

<!-- ═══ SCREEN 0: Hero Entry ═══ -->
<div class="step active" id="step0">
  <div style="display:flex;flex-direction:column;align-items:center;justify-content:center;min-height:100vh;text-align:center;padding:40px 20px">
    <div style="font-size:11px;font-weight:700;letter-spacing:2px;color:var(--amber);margin-bottom:16px;text-transform:uppercase">PowerRoof.my</div>
    <h1 style="font-size:clamp(28px,5vw,44px);font-weight:800;line-height:1.15;margin-bottom:20px;max-width:600;letter-spacing:-.5px">
      Solar ATAP<br>Feasibility Simulator
    </h1>
    <p style="font-size:17px;color:var(--g400);line-height:1.6;max-width:480;margin-bottom:40px">
      See if your factory qualifies — and how much value you may be leaving on the roof.
    </p>
    <p style="font-size:13px;color:var(--g500);margin-bottom:32px">Takes 2 minutes. No commitment required.</p>
    <button class="btn" onclick="goStep(1)">&#9654; Start Simulation</button>
    <div style="margin-top:48px;font-size:13px;color:var(--g500)">
      <span style="cursor:pointer;text-decoration:underline;text-underline-offset:4px">For EPC Partners → Login</span>
    </div>
  </div>
</div>

<!-- ═══ SCREEN 1: Company Profile Input ═══ -->
<div class="step" id="step1">
  <div class="container" style="padding-top:80px;padding-bottom:60px">
    <h2>Facility Profile</h2>
    <p class="subtitle">Tell us about your factory so we can model your solar potential.</p>
    <div class="card">
      <div style="display:grid;gap:24px">
        <div>
          <label>Industry Type</label>
          <select id="industry">
            <option>Plastics Manufacturing</option><option>Metal Fabrication</option>
            <option>Food & Beverage</option><option>Electronics Assembly</option>
            <option>Packaging / Paper</option><option>Chemical Processing</option>
            <option>Textile / Garment</option><option>Automotive Parts</option>
            <option>Furniture / Wood</option><option>Other Manufacturing</option>
          </select>
        </div>
        <div>
          <label>Estimated Roof Size</label>
          <select id="roofSize">
            <option>Small (5,000 – 10,000 sqft)</option>
            <option selected>Medium (10,000 – 20,000 sqft)</option>
            <option>Large (20,000 – 40,000 sqft)</option>
            <option>Very Large (40,000+ sqft)</option>
          </select>
        </div>
        <div>
          <label>Monthly TNB Bill (RM)</label>
          <div style="display:flex;align-items:center;gap:16px">
            <input type="range" id="monthlyBill" min="3000" max="50000" step="500" value="15000" oninput="updateBillLabel()">
            <span id="billLabel" style="min-width:90px;text-align:right;font-weight:700;font-size:16px;font-family:monospace">RM 15,000</span>
          </div>
        </div>
        <div>
          <label>Operating Hours</label>
          <div style="display:flex;gap:10px">
            <button class="hours-btn active" onclick="setHours(this,'Day')">Day</button>
            <button class="hours-btn" onclick="setHours(this,'Shift-based')">Shift-based</button>
            <button class="hours-btn" onclick="setHours(this,'24h')">24h</button>
          </div>
        </div>
        <div>
          <label>Location (Selangor Zone)</label>
          <select id="location">
            <option>Shah Alam</option><option>Klang</option><option>Petaling Jaya</option>
            <option>Subang Jaya</option><option>Rawang / Sungai Buloh</option>
            <option>Semenyih / Kajang</option><option>Puchong / Cyberjaya</option>
            <option>Port Klang</option><option>Other Selangor</option>
          </select>
        </div>
      </div>
      <div style="margin-top:32px;text-align:center">
        <button class="btn" onclick="goStep(2)">&#9654; Calculate Solar Fit</button>
      </div>
    </div>
  </div>
</div>

<!-- ═══ SCREEN 2: Solar Fit Score Reveal ═══ -->
<div class="step" id="step2">
  <div class="container" style="padding-top:80px;padding-bottom:60px">
    <h2>Your Solar Fit Score</h2>
    <p class="subtitle">Based on ATAP-specific optimisation logic.</p>
    <div class="card" style="text-align:center">
      <div id="scoreDisplay" style="font-size:72px;font-weight:800;line-height:1;margin-bottom:8px">
        <span id="scoreNum">0</span><span style="font-size:28px;color:var(--g500);font-weight:400"> / 100</span>
      </div>
      <div id="tierBadge" style="display:inline-block;padding:6px 16px;border-radius:20px;font-size:14px;font-weight:700;margin-bottom:32px"></div>
      <div id="breakdownBars" style="text-align:left;margin-top:24px"></div>
      <p style="font-size:12px;color:var(--g500);margin-top:20px;font-style:italic">
        Score reflects ATAP-specific optimisation logic. Full methodology in Intelligence Dossier.
      </p>
      <div style="margin-top:28px">
        <button class="btn" onclick="goStep(3)">&#9654; Explore System Sizing</button>
      </div>
    </div>
  </div>
</div>

<!-- ═══ SCREEN 3: Sizing Simulator ═══ -->
<div class="step" id="step3">
  <div class="container" style="padding-top:80px;padding-bottom:60px">
    <h2>System Sizing Simulator</h2>
    <p class="subtitle">Drag the slider to explore how system size affects value.</p>
    <div class="card">
      <div style="margin-bottom:32px">
        <div style="display:flex;justify-content:space-between;margin-bottom:8px">
          <span style="font-size:13px;color:var(--g400)">System Size</span>
          <span id="sizeLabel" style="font-size:24px;font-weight:800;font-family:monospace">250 kWp</span>
        </div>
        <input type="range" id="sizeSlider" min="50" max="500" step="10" value="250" oninput="updateSizing()">
        <div style="display:flex;justify-content:space-between;font-size:11px;color:var(--g500)">
          <span id="sizeMin">50 kWp</span>
          <span id="sizeOpt" style="color:var(--green)">Optimal: ~163 kWp</span>
          <span id="sizeMax">500 kWp</span>
        </div>
      </div>
      <div class="metric-grid" id="sizingMetrics"></div>
      <div id="splitBar" style="margin-bottom:16px"></div>
      <div id="forfeitureRisk"></div>
      <div id="sizingInsight" style="display:none" class="insight"></div>
      <div style="margin-top:28px;text-align:center">
        <button class="btn" onclick="goStep(4)">&#9654; Run SMP Sensitivity</button>
      </div>
    </div>
  </div>
</div>

<!-- ═══ SCREEN 4: SMP Sensitivity ═══ -->
<div class="step" id="step4">
  <div class="container" style="padding-top:80px;padding-bottom:60px">
    <h2>SMP Sensitivity Playground</h2>
    <p class="subtitle">See how Singlebuyer Market Price affects your returns.</p>
    <div class="card">
      <div style="margin-bottom:32px">
        <div style="display:flex;justify-content:space-between;margin-bottom:8px">
          <span style="font-size:13px;color:var(--g400)">SMP Rate (RM/kWh)</span>
          <span id="smpLabel" style="font-size:24px;font-weight:800;font-family:monospace">RM 0.228</span>
        </div>
        <input type="range" id="smpSlider" min="0.15" max="0.40" step="0.005" value="0.228" oninput="updateSMP()">
        <div style="display:flex;justify-content:space-between;font-size:11px;color:var(--g500)">
          <span>RM 0.150 (Conservative)</span>
          <span style="color:var(--red)">Floor: RM 0.200</span>
          <span>RM 0.400 (Optimistic)</span>
        </div>
      </div>
      <div class="metric-grid" id="smpMetrics"></div>
      <div style="background:rgba(59,130,246,.08);border:1px solid rgba(59,130,246,.2);border-radius:8px;padding:14px 18px;margin-bottom:20px">
        <p style="font-size:14px;color:var(--blue);font-weight:600;margin-bottom:4px">Key Insight</p>
        <p id="smpInsight" style="font-size:13px;color:var(--g300);line-height:1.6">
          Primary ROI driver is tariff displacement (self-consumption at RM 0.334/kWh), not export credit.
        </p>
      </div>
      <div style="margin-top:28px;text-align:center">
        <button class="btn" onclick="goStep(5)">&#9654; See 25-Year Cashflow</button>
      </div>
    </div>
  </div>
</div>

<!-- ═══ SCREEN 5: Cashflow Visualisation ═══ -->
<div class="step" id="step5">
  <div class="container" style="padding-top:80px;padding-bottom:60px">
    <h2>25-Year Cashflow Projection</h2>
    <p class="subtitle">Cumulative net value over the system lifetime.</p>
    <div class="card">
      <div style="text-align:center;margin-bottom:28px">
        <div style="font-size:14px;color:var(--g400);margin-bottom:4px">Projected Lifetime Net Value</div>
        <div id="lifetimeValue" style="font-size:40px;font-weight:800;color:var(--green);font-family:monospace"></div>
      </div>
      <svg id="cashflowChart" viewBox="0 0 600 250" style="width:100%;max-width:600px;display:block;margin:0 auto"></svg>
      <p style="font-size:12px;color:var(--g500);margin-top:16px;text-align:center;font-style:italic">
        Estimate excludes carbon credit potential and future tariff escalation. Includes 0.5% annual degradation and maintenance reserve.
      </p>
      <div style="margin-top:20px;padding:12px 16px;background:rgba(34,197,94,.08);border:1px solid rgba(34,197,94,.2);border-radius:8px;text-align:center">
        <p id="comparisonBadge" style="font-size:13px;color:var(--green);font-weight:500"></p>
      </div>
      <div style="margin-top:28px;text-align:center">
        <button class="btn" onclick="goStep(6)">Unlock Detailed Intelligence Dossier</button>
      </div>
    </div>
  </div>
</div>

<!-- ═══ SCREEN 6: Paywall CTA ═══ -->
<div class="step" id="step6">
  <div class="container" style="padding-top:40px;padding-bottom:60px">
    <div style="text-align:center;margin-bottom:40px">
      <h2 style="font-size:28px">Your Factory Qualifies</h2>
      <p style="color:var(--g400);font-size:15px;max-width:480;margin:12px auto 0">
        Your facility demonstrates strong ATAP alignment. Proceed with detailed intelligence to validate feasibility.
      </p>
    </div>
    <!-- Blurred previews -->
    <div style="display:grid;grid-template-columns:1fr 1fr 1fr;gap:12px;margin-bottom:40px">
      <div style="background:var(--g700);border-radius:10px;padding:20px;text-align:center;filter:blur(1px);opacity:.6">
        <div style="font-size:28px;margin-bottom:8px">&#128752;</div>
        <div style="font-size:12px;color:var(--g400)">Roof Satellite Overlay</div>
      </div>
      <div style="background:var(--g700);border-radius:10px;padding:20px;text-align:center;filter:blur(1px);opacity:.6">
        <div style="font-size:28px;margin-bottom:8px">&#128202;</div>
        <div style="font-size:12px;color:var(--g400)">Export Risk Heatmap</div>
      </div>
      <div style="background:var(--g700);border-radius:10px;padding:20px;text-align:center;filter:blur(1px);opacity:.6">
        <div style="font-size:28px;margin-bottom:8px">&#128208;</div>
        <div style="font-size:12px;color:var(--g400)">Panel Layout Concept</div>
      </div>
    </div>
    <!-- 3-Tier pricing -->
    <div style="display:grid;grid-template-columns:1fr 1fr 1fr;gap:16px;margin-bottom:32px">
      <!-- Snapshot -->
      <div class="tier-card">
        <div style="font-size:11px;font-weight:700;letter-spacing:1px;color:var(--green);margin-bottom:8px;text-transform:uppercase">Snapshot</div>
        <div style="font-size:28px;font-weight:800;margin-bottom:4px">Free</div>
        <div style="font-size:12px;color:var(--g500);margin-bottom:20px">Quick eligibility check</div>
        <div style="text-align:left;font-size:13px;color:var(--g400);line-height:2">
          ✓ ATAP eligibility<br>✓ Indicative savings<br>✓ Solar Fit Score<br>
          <span style="color:var(--g600)">✗ Financial model</span><br>
          <span style="color:var(--g600)">✗ Roof analysis</span>
        </div>
        <button style="margin-top:20px;width:100%;padding:10px;border-radius:8px;background:transparent;border:1px solid var(--green);color:var(--green);font-size:13px;font-weight:600;cursor:pointer">Download Snapshot</button>
      </div>
      <!-- Feasibility -->
      <div class="tier-card" style="border:2px solid var(--amber);transform:scale(1.03);position:relative">
        <div style="position:absolute;top:-12px;left:50%;transform:translateX(-50%);background:var(--amber);color:var(--g900);font-size:10px;font-weight:700;padding:3px 12px;border-radius:10px;letter-spacing:1px">POPULAR</div>
        <div style="font-size:11px;font-weight:700;letter-spacing:1px;color:var(--amber);margin-bottom:8px;text-transform:uppercase">Feasibility</div>
        <div style="font-size:28px;font-weight:800;margin-bottom:4px">RM 1,000</div>
        <div style="font-size:12px;color:var(--g500);margin-bottom:20px">Detailed assessment</div>
        <div style="text-align:left;font-size:13px;color:var(--g400);line-height:2">
          ✓ Everything in Snapshot<br>✓ Financial model<br>✓ SMP sensitivity<br>✓ Sizing optimisation<br>✓ Risk commentary
        </div>
        <button style="margin-top:20px;width:100%;padding:10px;border-radius:8px;background:var(--amber);border:none;color:var(--g900);font-size:13px;font-weight:700;cursor:pointer">Request Assessment</button>
      </div>
      <!-- Dossier -->
      <div class="tier-card" style="border-color:rgba(59,130,246,.27)">
        <div style="font-size:11px;font-weight:700;letter-spacing:1px;color:var(--blue);margin-bottom:8px;text-transform:uppercase">Intelligence Dossier</div>
        <div style="font-size:28px;font-weight:800;margin-bottom:4px">RM 2,000</div>
        <div style="font-size:12px;color:var(--g500);margin-bottom:20px">Board-ready report</div>
        <div style="text-align:left;font-size:13px;color:var(--g400);line-height:2">
          ✓ Everything in Feasibility<br>✓ Roof satellite analysis<br>✓ Panel layout concept<br>✓ Carbon / ESG impact<br>✓ Executive summary
        </div>
        <button style="margin-top:20px;width:100%;padding:10px;border-radius:8px;background:transparent;border:1px solid var(--blue);color:var(--blue);font-size:13px;font-weight:600;cursor:pointer">Request Dossier</button>
      </div>
    </div>
    <div style="text-align:center;margin-bottom:32px">
      <p style="font-size:13px;color:var(--g400);font-style:italic">Assessment fee fully deductible upon project award.</p>
      <p style="font-size:12px;color:var(--g500)">Average dossier turnaround: 48 hours.</p>
    </div>
    <div style="text-align:center;padding:14px 20px;background:rgba(245,158,11,.06);border:1px solid rgba(245,158,11,.13);border-radius:8px;margin-bottom:40px">
      <p style="font-size:13px;color:var(--amber-dim)">Solar ATAP allocation is subject to capacity window. Quota availability may vary by zone.</p>
    </div>
    <div style="text-align:center;padding-bottom:40px">
      <button onclick="goStep(0)" style="background:transparent;border:1px solid var(--border);color:var(--g400);padding:10px 24px;border-radius:8px;font-size:13px;cursor:pointer">← Run Another Simulation</button>
    </div>
  </div>
</div>

<script>
// ─── Data tables ───
const INDUSTRIES={
  "Plastics Manufacturing":{ei:.88,sb:.85},"Metal Fabrication":{ei:.92,sb:.80},
  "Food & Beverage":{ei:.75,sb:.90},"Electronics Assembly":{ei:.82,sb:.88},
  "Packaging / Paper":{ei:.78,sb:.82},"Chemical Processing":{ei:.95,sb:.75},
  "Textile / Garment":{ei:.70,sb:.85},"Automotive Parts":{ei:.85,sb:.82},
  "Furniture / Wood":{ei:.65,sb:.80},"Other Manufacturing":{ei:.80,sb:.82}
};
const ROOFS={
  "Small (5,000 – 10,000 sqft)":{sqft:7500,max:120},
  "Medium (10,000 – 20,000 sqft)":{sqft:15000,max:250},
  "Large (20,000 – 40,000 sqft)":{sqft:30000,max:450},
  "Very Large (40,000+ sqft)":{sqft:50000,max:700}
};
const LOCS={
  "Shah Alam":{ir:1320,cl:10},"Klang":{ir:1300,cl:9},"Petaling Jaya":{ir:1310,cl:8},
  "Subang Jaya":{ir:1310,cl:8},"Rawang / Sungai Buloh":{ir:1290,cl:7},
  "Semenyih / Kajang":{ir:1300,cl:7},"Puchong / Cyberjaya":{ir:1310,cl:8},
  "Port Klang":{ir:1290,cl:9},"Other Selangor":{ir:1300,cl:6}
};

let currentStep=0, hours="Day";

function getInputs(){
  return{
    industry:document.getElementById("industry").value,
    roof:document.getElementById("roofSize").value,
    bill:+document.getElementById("monthlyBill").value,
    hours,
    location:document.getElementById("location").value
  };
}

function goStep(n){
  document.getElementById("step"+currentStep).classList.remove("active");
  currentStep=n;
  document.getElementById("step"+n).classList.add("active");
  // Progress bar
  const pb=document.getElementById("progressBar");
  if(n>0&&n<7){
    pb.style.display="block";
    document.getElementById("stepLabel").textContent=`Step ${n} of 6`;
    document.getElementById("progressFill").style.width=((n)/6*100)+"%";
  }else{pb.style.display="none"}
  window.scrollTo(0,0);
  if(n===2)revealScore();
  if(n===3)initSizing();
  if(n===4)updateSMP();
  if(n===5)buildCashflow();
}

function setHours(el,v){
  hours=v;
  document.querySelectorAll(".hours-btn").forEach(b=>b.classList.remove("active"));
  el.classList.add("active");
}

function updateBillLabel(){
  const v=+document.getElementById("monthlyBill").value;
  document.getElementById("billLabel").textContent="RM "+v.toLocaleString();
}

// ─── Score calculation ───
function calcScore(){
  const inp=getInputs();
  const roof=ROOFS[inp.roof]||ROOFS["Medium (10,000 – 20,000 sqft)"];
  const ind=INDUSTRIES[inp.industry]||INDUSTRIES["Other Manufacturing"];
  const loc=LOCS[inp.location]||LOCS["Other Selangor"];
  const demandKwp=(inp.bill/.334)/150;
  const roofRatio=Math.min(roof.max/Math.max(demandKwp,50),2);
  const roofS=Math.min(30,Math.round(15+roofRatio*7.5));
  const energyS=Math.min(25,Math.round(ind.ei*25));
  const hf=inp.hours==="24h"?1:inp.hours==="Shift-based"?.85:.7;
  const exportS=Math.min(15,Math.round(hf*ind.sb*15));
  const clusterS=Math.min(15,Math.round((loc.cl/10)*15));
  const policyS=14;
  const total=Math.min(100,roofS+energyS+exportS+clusterS+policyS);
  const tier=total>=80?"A":total>=65?"B":total>=50?"C":"D";
  return{total,tier,breakdown:[
    {label:"Roof Suitability",score:roofS,max:30},
    {label:"Energy Intensity",score:energyS,max:25},
    {label:"Self-Consumption Potential",score:exportS,max:15},
    {label:"Industrial Cluster Value",score:clusterS,max:15},
    {label:"ATAP Policy Alignment",score:policyS,max:15}
  ]};
}

function revealScore(){
  const s=calcScore();
  const col=s.total>=80?"var(--green)":s.total>=65?"var(--amber)":"var(--red)";
  // Animate score number
  const el=document.getElementById("scoreNum");
  let cur=0;const target=s.total;
  el.style.color=col;
  const intv=setInterval(()=>{
    cur+=Math.ceil((target-cur)/8)||1;
    if(cur>=target){cur=target;clearInterval(intv)}
    el.textContent=cur;
  },40);
  // Tier badge
  const badge=document.getElementById("tierBadge");
  const tierLabel={A:"High Strategic Potential",B:"Strong Potential",C:"Moderate Potential",D:"Review Required"};
  badge.textContent=`Tier ${s.tier} — ${tierLabel[s.tier]}`;
  badge.style.background=col+"22";badge.style.color=col;
  // Breakdown bars
  const barsEl=document.getElementById("breakdownBars");
  barsEl.innerHTML="";
  s.breakdown.forEach((b,i)=>{
    const pct=(b.score/b.max)*100;
    const c=pct>=80?"var(--green)":pct>=60?"var(--amber)":"var(--red)";
    barsEl.innerHTML+=`<div style="margin-bottom:12px">
      <div style="display:flex;justify-content:space-between;margin-bottom:4px;font-size:13px;color:var(--g400)">
        <span>${b.label}</span><span style="color:#fff;font-weight:600">${b.score}/${b.max}</span>
      </div>
      <div class="score-bar-track"><div class="score-bar-fill" id="bar${i}" style="width:0%;background:${c}"></div></div>
    </div>`;
    setTimeout(()=>{document.getElementById("bar"+i).style.width=pct+"%"},200+i*200);
  });
}

// ─── Sizing ───
function calcSizing(sizeKwp){
  const inp=getInputs();
  const ind=INDUSTRIES[inp.industry]||INDUSTRIES["Other Manufacturing"];
  const loc=LOCS[inp.location]||LOCS["Other Selangor"];
  const hf=inp.hours==="24h"?1:inp.hours==="Shift-based"?.85:.7;
  const annGen=sizeKwp*loc.ir;
  const annDemand=(inp.bill/.334)*12;
  const baseSC=hf*ind.sb;
  const gr=annGen/Math.max(annDemand,1);
  const sc=Math.min(95,Math.max(40,Math.round(baseSC*100*(1-Math.max(0,gr-.8)*.5))));
  const exp=100-sc;
  const selfS=annGen*(sc/100)*.334;
  const expS=annGen*(exp/100)*.228;
  const savings=Math.round(selfS+expS);
  const capex=sizeKwp*2000+8000;
  const payback=Math.round((capex/savings)*10)/10;
  const risk=exp>35?"High":exp>20?"Medium":"Low";
  return{sc,exp,savings,payback,risk,annGen,capex};
}

function initSizing(){
  const inp=getInputs();
  const roof=ROOFS[inp.roof]||ROOFS["Medium (10,000 – 20,000 sqft)"];
  const min=Math.max(50,Math.round(roof.max*.3));
  const max=Math.round(roof.max*1.1);
  const opt=Math.round(roof.max*.65);
  const sl=document.getElementById("sizeSlider");
  sl.min=min;sl.max=max;sl.value=opt;
  document.getElementById("sizeMin").textContent=min+" kWp";
  document.getElementById("sizeMax").textContent=max+" kWp";
  document.getElementById("sizeOpt").textContent="Optimal: ~"+opt+" kWp";
  updateSizing();
}

function updateSizing(){
  const v=+document.getElementById("sizeSlider").value;
  document.getElementById("sizeLabel").textContent=v+" kWp";
  const s=calcSizing(v);
  const inp=getInputs();
  const roof=ROOFS[inp.roof]||ROOFS["Medium (10,000 – 20,000 sqft)"];
  const opt=Math.round(roof.max*.65);
  // Metrics
  const payCol=s.payback>8?"var(--red)":s.payback>6?"var(--amber)":"var(--green)";
  const expCol=s.exp>30?"var(--red)":"var(--amber)";
  document.getElementById("sizingMetrics").innerHTML=[
    {l:"Self-Consumption",v:s.sc+"%",c:"var(--green)"},
    {l:"Export",v:s.exp+"%",c:expCol},
    {l:"Annual Savings",v:"RM "+s.savings.toLocaleString(),c:"#fff"},
    {l:"Payback",v:s.payback+" years",c:payCol}
  ].map(m=>`<div class="metric"><div class="metric-label">${m.l}</div><div class="metric-value" style="color:${m.c}">${m.v}</div></div>`).join("");
  // Split bar
  const sb=document.getElementById("splitBar");
  const selfBg="var(--green)";const expBg=s.exp>30?"var(--red)":"var(--amber)";
  sb.innerHTML=`<div style="font-size:12px;color:var(--g400);margin-bottom:6px">Generation Split</div>
    <div style="display:flex;height:28px;border-radius:6px;overflow:hidden">
      <div style="width:${s.sc}%;background:${selfBg};display:flex;align-items:center;justify-content:center;font-size:11px;font-weight:700;color:var(--g900);transition:width .3s">${s.sc}% Self</div>
      <div style="width:${s.exp}%;background:${expBg};display:flex;align-items:center;justify-content:center;font-size:11px;font-weight:700;color:var(--g900);transition:width .3s">${s.exp}% Export</div>
    </div>`;
  // Risk
  const rCol=s.risk==="High"?"var(--red)":s.risk==="Medium"?"var(--amber)":"var(--green)";
  const rIcon=s.risk==="High"?"⚠":s.risk==="Medium"?"◐":"✓";
  const rBg=s.risk==="High"?"rgba(239,68,68,.1)":s.risk==="Medium"?"rgba(245,158,11,.1)":"rgba(34,197,94,.1)";
  document.getElementById("forfeitureRisk").innerHTML=`<div style="display:flex;align-items:center;gap:8px;padding:10px 14px;background:${rBg};border:1px solid ${rCol}33;border-radius:8px;font-size:13px">
    <span style="color:${rCol}">${rIcon}</span><span style="color:var(--g300)">Export Forfeiture Risk: <strong style="color:${rCol}">${s.risk}</strong></span></div>`;
  // Insight
  const insEl=document.getElementById("sizingInsight");
  if(v>opt*1.3){
    const loss=Math.round((v-opt)*50);
    insEl.style.display="flex";
    insEl.innerHTML=`<span style="font-size:16px">⚡</span><span>Oversizing beyond ${opt} kWp increases export exposure. Estimated value reduction: RM ${loss.toLocaleString()}/year.</span>`;
  }else if(v<opt*.7){
    insEl.style.display="flex";
    insEl.innerHTML=`<span style="font-size:16px">⚡</span><span>Undersizing leaves roof capacity unused. Consider optimising for maximum self-consumption coverage.</span>`;
  }else{insEl.style.display="none"}
}

// ─── SMP ───
function updateSMP(){
  const smp=+document.getElementById("smpSlider").value;
  document.getElementById("smpLabel").textContent="RM "+smp.toFixed(3);
  const v=+document.getElementById("sizeSlider").value;
  const inp=getInputs();
  const ind=INDUSTRIES[inp.industry]||INDUSTRIES["Other Manufacturing"];
  const loc=LOCS[inp.location]||LOCS["Other Selangor"];
  const hf=inp.hours==="24h"?1:inp.hours==="Shift-based"?.85:.7;
  const annGen=v*loc.ir;
  const annDemand=(inp.bill/.334)*12;
  const baseSC=hf*ind.sb;
  const gr=annGen/Math.max(annDemand,1);
  const sc=Math.min(95,Math.max(40,Math.round(baseSC*100*(1-Math.max(0,gr-.8)*.5))));
  const exp=100-sc;
  const selfS=annGen*(sc/100)*.334;
  const expS=annGen*(exp/100)*smp;
  const savings=Math.round(selfS+expS);
  const capex=v*2000+8000;
  const payback=Math.round((capex/savings)*10)/10;
  const payCol=payback>8?"var(--red)":payback>6?"var(--amber)":"var(--green)";
  document.getElementById("smpMetrics").innerHTML=`
    <div class="metric"><div class="metric-label">Annual Savings</div><div class="metric-value">RM ${savings.toLocaleString()}</div></div>
    <div class="metric"><div class="metric-label">Payback Period</div><div class="metric-value" style="color:${payCol}">${payback} years</div></div>`;
  const insText=sc>=75?"Your high self-consumption ratio means SMP volatility has limited impact on overall returns.":"Consider optimising system size to increase self-consumption dominance.";
  document.getElementById("smpInsight").textContent="Primary ROI driver is tariff displacement (self-consumption at RM 0.334/kWh), not export credit. "+insText;
}

// ─── Cashflow ───
function buildCashflow(){
  const v=+document.getElementById("sizeSlider").value;
  const s=calcSizing(v);
  const capex=s.capex;
  let cum=-capex,be=25;
  const data=[{y:0,v:cum}];
  for(let y=1;y<=25;y++){
    const deg=Math.pow(.995,y);
    const ys=s.savings*deg;
    const maint=3000+(y>10?2000:0);
    cum+=ys-maint;
    data.push({y,v:Math.round(cum)});
    if(cum>=0&&data[y-1].v<0){be=y-1+(-data[y-1].v/(cum-data[y-1].v));be=Math.round(be*10)/10}
  }
  // Animate lifetime value
  const lvEl=document.getElementById("lifetimeValue");
  const target=Math.round(data[25].v/1000);
  let cur=0;
  const intv=setInterval(()=>{cur+=Math.ceil((target-cur)/10)||1;if(cur>=target){cur=target;clearInterval(intv)}lvEl.textContent="RM "+cur.toLocaleString()+"k+";},30);
  // SVG chart
  const W=600,H=250,P={t:20,r:20,b:35,l:65};
  const cW=W-P.l-P.r,cH=H-P.t-P.b;
  const minV=Math.min(...data.map(d=>d.v));
  const maxV=Math.max(...data.map(d=>d.v));
  const range=maxV-minV||1;
  const toX=i=>P.l+(i/25)*cW;
  const toY=v=>P.t+cH-((v-minV)/range)*cH;
  const zY=toY(0);
  let svg="";
  // Grid
  [-500000,0,500000,1000000,1500000,2000000].forEach(gv=>{
    if(gv<minV||gv>maxV*1.1)return;
    svg+=`<line x1="${P.l}" y1="${toY(gv)}" x2="${W-P.r}" y2="${toY(gv)}" stroke="#262626" stroke-width=".5" stroke-dasharray="4,4"/>`;
    svg+=`<text x="${P.l-8}" y="${toY(gv)+4}" fill="#6b7280" font-size="10" text-anchor="end">${gv>=0?"RM "+(gv/1000).toFixed(0)+"k":"-RM "+(Math.abs(gv)/1000).toFixed(0)+"k"}</text>`;
  });
  [0,5,10,15,20,25].forEach(y=>{svg+=`<text x="${toX(y)}" y="${H-5}" fill="#6b7280" font-size="10" text-anchor="middle">Yr ${y}</text>`});
  svg+=`<line x1="${P.l}" y1="${zY}" x2="${W-P.r}" y2="${zY}" stroke="#9ca3af" stroke-width="1"/>`;
  // Fills
  data.forEach((d,i)=>{
    if(i===0)return;
    if(d.v<0)svg+=`<rect x="${toX(i-1)}" y="${zY}" width="${cW/25}" height="${Math.min(toY(d.v)-zY,cH)}" fill="rgba(239,68,68,.15)"/>`;
    if(d.v>0)svg+=`<rect x="${toX(i)-cW/50}" y="${toY(d.v)}" width="${cW/25}" height="${zY-toY(d.v)}" fill="rgba(34,197,94,.12)"/>`;
  });
  // Line
  const pts=data.map(d=>`${toX(d.y)},${toY(d.v)}`).join(" ");
  svg+=`<polyline fill="none" stroke="${AMBER}" stroke-width="2.5" points="${pts}"/>`;
  // Breakeven
  if(be<25){
    svg+=`<line x1="${toX(be)}" y1="${P.t}" x2="${toX(be)}" y2="${H-P.b}" stroke="#22C55E" stroke-width="1" stroke-dasharray="5,3"/>`;
    svg+=`<text x="${toX(be)}" y="${P.t-4}" fill="#22C55E" font-size="10" text-anchor="middle" font-weight="bold">Breakeven ~${be.toFixed(1)}yr</text>`;
  }
  svg+=`<text x="${toX(25)+5}" y="${toY(data[25].v)+4}" fill="#22C55E" font-size="11" font-weight="bold">+RM ${(data[25].v/1000).toFixed(0)}k</text>`;
  document.getElementById("cashflowChart").innerHTML=svg;
  const inp=getInputs();
  document.getElementById("comparisonBadge").textContent=`Compared to similar ${inp.industry.toLowerCase()} facilities in ${inp.location}, this projection is within the top performance quartile.`;
}

const AMBER="#F59E0B";
</script>
</body>
</html>
